var i=Object.defineProperty,t=("undefined"!=typeof require&&require,(t,e,s)=>(((t,e,s)=>{e in t?i(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s})(t,"symbol"!=typeof e?e+"":e,s),s));!function(){const i=document.createElement("link").relList;if(!(i&&i.supports&&i.supports("modulepreload"))){for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver((i=>{for(const e of i)if("childList"===e.type)for(const i of e.addedNodes)"LINK"===i.tagName&&"modulepreload"===i.rel&&t(i)})).observe(document,{childList:!0,subtree:!0})}function t(i){if(i.ep)return;i.ep=!0;const t=function(i){const t={};return i.integrity&&(t.integrity=i.integrity),i.referrerpolicy&&(t.referrerPolicy=i.referrerpolicy),"use-credentials"===i.crossorigin?t.credentials="include":"anonymous"===i.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(i);fetch(i.href,t)}}();var e="/rec-rts/assets/spritesheet.b7fabffe.png";class s{constructor(i,e){t(this,"x"),t(this,"y"),t(this,"xa",0),t(this,"ya",0),t(this,"dirX",0),t(this,"isDead",!1),t(this,"isPlayingDeadAnimation",!1),this.x=i,this.y=e}update(i){}move(i){if(0!==this.xa||0!==this.ya){let t=!0;return 0!==this.xa&&this.move2(i,this.xa,0)&&(t=!1),0!==this.ya&&this.move2(i,0,this.ya)&&(t=!1),0===this.xa||0===this.ya||this.move3(i,this.xa,this.ya)||(this.xa=0,this.ya=0),!t}return!0}move3(i,t,e){const s=this.x+t,h=this.y+e;return!!i.getTile(1===t?Math.floor(s):Math.round(s),1===e?Math.floor(h):Math.round(h)).isPassable}move2(i,t,e){const s=this.x-0,h=this.y-0,a=this.x+0,n=this.y+0,r=this.x+t-0,o=this.y+e-0,d=this.x+t+0,l=this.y+e+0;let m=!1;for(let g=o;g<=l;g++)for(let t=r;t<=d;t++)if(!(t>=s&&t<=a&&g>=h&&g<=n||i.getTile(Math.round(t),Math.round(g)).isPassable))return m=!0,!1;return!m&&(this.x+=t/16,this.y+=e/16,!0)}}class h extends s{constructor(){super(...arguments),t(this,"tx",0),t(this,"maxTx",4),t(this,"ty",12),t(this,"movingTx",4),t(this,"maxMovingTx",10),t(this,"moving",!0),t(this,"animation",0),t(this,"movingAnimation",0),t(this,"deadAnimationTx",8),t(this,"maxDeadAnimationTx",14),t(this,"deadAnimation",0),t(this,"isPunching",!1),t(this,"punchTx",16),t(this,"maxPunchAnimationTx",22),t(this,"punchAnimation",0)}render(i,t,e,s){this.isPunching?i.renderEntity(t,8*this.punchTx,1===this.dirX?8*(this.ty+2):8*this.ty,this.x,this.y,e,s):this.isPlayingDeadAnimation||this.isDead?i.renderEntity(t,8*this.deadAnimationTx,1===this.dirX?8*(this.ty+2):8*this.ty,this.x,this.y,e,s):i.renderEntity(t,this.moving?8*this.movingTx:8*this.tx,-1===this.xa||1===this.dirX?8*(this.ty+2):8*this.ty,this.x,this.y,e,s)}update(i){if(this.isPunching)return this.punchAnimation+=1,void(this.punchAnimation%2==0&&(this.punchAnimation=0,this.punchTx+=2,this.punchTx===this.maxPunchAnimationTx&&(this.punchTx=16,this.isPunching=!1)));0===Math.round(20*Math.random())&&(this.isPunching=!0),0===Math.round(100*Math.random())&&(this.isPlayingDeadAnimation=!0),this.isPlayingDeadAnimation?this.playDeadAnimation():(1===this.xa||1===this.ya?(this.moving=!0,this.dirX=0):-1===this.xa||-1===this.ya?(this.moving=!0,this.dirX=1):this.moving=!1,this.move(i)?0===Math.floor(20*Math.random())&&(this.xa=Math.floor(3*Math.random())-1,this.ya=Math.floor(3*Math.random())-1):(this.xa=0,this.ya=0),this.animation+=1,this.movingAnimation+=1,this.animation%5!=0||this.moving||(this.animation=0,this.tx+=2,this.tx%this.maxTx==0&&(this.tx=0)),this.movingAnimation%2==0&&this.moving&&(this.movingAnimation=0,this.movingTx+=2,this.movingTx%this.maxMovingTx==0&&(this.movingTx=4)))}playDeadAnimation(){this.isDead||(this.deadAnimation+=1,this.deadAnimation%2==0&&(this.deadAnimation=0,this.deadAnimationTx+=2,this.deadAnimationTx===this.maxDeadAnimationTx&&(this.isDead=!0)))}}class a extends s{constructor(){super(...arguments),t(this,"tx",0),t(this,"maxTx",4),t(this,"ty",16),t(this,"movingTx",4),t(this,"maxMovingTx",10),t(this,"moving",!0),t(this,"animation",0),t(this,"movingAnimation",0),t(this,"deadAnimationTx",8),t(this,"maxDeadAnimationTx",14),t(this,"deadAnimation",0)}render(i,t,e,s){this.isPlayingDeadAnimation||this.isDead?i.renderEntity(t,8*this.deadAnimationTx,1===this.dirX?8*(this.ty+2):8*this.ty,this.x,this.y,e,s):i.renderEntity(t,this.moving?8*this.movingTx:8*this.tx,-1===this.xa||1===this.dirX?8*(this.ty+2):8*this.ty,this.x,this.y,e,s)}update(i){0===Math.round(100*Math.random())&&(this.isPlayingDeadAnimation=!0),this.isPlayingDeadAnimation?this.playDeadAnimation():(1===this.xa||1===this.ya?(this.moving=!0,this.dirX=0):-1===this.xa||-1===this.ya?(this.moving=!0,this.dirX=1):this.moving=!1,this.move(i)?0===Math.floor(20*Math.random())&&(this.xa=Math.floor(3*Math.random())-1,this.ya=Math.floor(3*Math.random())-1):(this.xa=0,this.ya=0),this.animation+=1,this.movingAnimation+=1,this.animation%7!=0||this.moving||(this.animation=0,this.tx+=2,this.tx%this.maxTx==0&&(this.tx=0)),this.movingAnimation%2==0&&this.moving&&(this.movingAnimation=0,this.movingTx+=2,this.movingTx%this.maxMovingTx==0&&(this.movingTx=4)))}playDeadAnimation(){this.isDead||(this.deadAnimation+=1,this.deadAnimation%2==0&&(this.deadAnimation=0,this.deadAnimationTx+=2,this.deadAnimationTx===this.maxDeadAnimationTx&&(this.isDead=!0)))}}Math.seed=i=>{const t=4294967295;let e=123456789+i&t,s=987654321-i&t;return()=>{s=36969*(65535&s)+(s>>>16)&t,e=18e3*(65535&e)+(e>>>16)&t;let i=(s<<16)+(65535&e)>>>0;return i/=4294967296,i}};let n=Math.seed(Math.random()*(10+90*Math.random()));class r{constructor(i,e,s){t(this,"w"),t(this,"h"),t(this,"values"),this.w=i,this.h=e,this.values=new Array(i*e);for(let t=0;t<e;t+=s)for(let e=0;e<i;e+=s)this.setSample(e,t,2*n()-1);let h=s,a=1/i,r=1;do{const t=h/2;for(let s=0;s<e;s+=h)for(let e=0;e<i;e+=h){const i=(this.sample(e,s)+this.sample(e+h,s)+this.sample(e,s+h)+this.sample(e+h,s+h))/4+(2*n()-1)*h*a;this.setSample(e+t,s+t,i)}for(let e=0;e<i;e+=h)for(let s=0;s<i;s+=h){const i=this.sample(s,e),r=this.sample(s+h,e),o=this.sample(s,e+h),d=this.sample(s+t,e+t),l=this.sample(s+t,e-t),m=this.sample(s-t,e+t),g=(i+r+d+l)/4+(2*n()-1)*h*a*.5,c=(i+o+d+m)/4+(2*n()-1)*h*a*.5;this.setSample(s+t,e,g),this.setSample(s,e+t,c)}h/=2,a*=r+.8,r*=.3}while(h>1)}sample(i,t){return this.values[(i&this.w-1)+(t&this.h-1)*this.w]}setSample(i,t,e){this.values[(i&this.w-1)+(t&this.h-1)*this.w]=e}}const o=(i,t,e=Math.random()*Number.MAX_SAFE_INTEGER)=>{n=Math.seed(e);const s=new r(i,t,16),h=new r(i,t,16),a=new r(i,t,16),o=new r(i,t,32),l=new r(i,t,32),m=new Array(i*t),g=new Array(i*t);for(let n=0;n<t;n++)for(let e=0;e<i;e++){const r=e+n*i;let d=3*Math.abs(o.values[r]-l.values[r])-2,g=Math.abs(s.values[r]-h.values[r]);g=3*Math.abs(g-a.values[r])-2;let T=e/(i-1)*2-1,u=n/(t-1)*2-1;T<0&&(T=-T),u<0&&(u=-u);let f=T>=u?T:u;f*=f*f*f,f*=f*f*f,d=d+1-20*f,m[r]=d<-.5?c.water.id:d>.5&&g<-1.5?c.rock.id:c.grass.id}for(let r=0;r<i*t/2800;r++){let e=Math.round(n()*i),s=Math.round(n()*t);for(let h=0;h<10;h++){let h=e+Math.round(21*n()-10),a=s+Math.round(21*n()-10);for(let e=0;e<100;e++){let e=h+Math.round(5*n())-Math.round(5*n()),s=a+Math.round(5*n())-Math.round(5*n());for(let h=s-1;h<=s+1;h++)for(let s=e-1;s<=e+1;s++)s>=0&&h>=0&&s<i&&h<t&&1==m[s+h*i]&&(m[s+h*i]=c.sand.id)}}}for(let r=0;r<i*t/400;r++){const e=Math.round(n()*i),s=Math.round(n()*t);for(let h=0;h<200;h++){const h=e+Math.round(15*n())-Math.round(15*n()),a=s+Math.round(15*n())-Math.round(15*n());h>=0&&a>=0&&h<i&&a<t&&m[h+a*i]==c.grass.id&&(m[h+a*i]=c.tree.id)}}for(let r=0;r<i*t/40;r++){const e=Math.round(n()*i),s=Math.round(n()*t);e>=0&&s>=0&&e<i&&s<<t&&m[e+s*i]===c.sand.id&&(m[e+s*i]=c.cactus.id)}for(let r=0;r<i*t/400;r++){const e=Math.round(n()*i),s=Math.round(n()*t);for(let h=0;h<30;h++){const h=e+Math.round(5*n())-Math.round(5*n()),a=s+Math.round(5*n())-Math.round(5*n());h>=0&&a>=0&&h<i&&a<t&&m[h+a*i]==c.grass.id&&(m[h+a*i]=c.flower.id)}}let T=-1,u=-1;for(;-1===T||-1===u;){T=Math.round(n()*i),u=Math.round(n()*t);i:for(let t=u-1;t<=u+1;t++)for(let e=T-1;e<=T+1;e++)if(m[e+t*i]===c.water.id||m[e+t*i]===c.rock.id||m[e+t*i]===c.tree.id){T=-1,u=-1;break i}const e=d(m,i,T,u,3,3,c.tree.id),s=d(m,i,T,u,5,1,c.rock.id);e&&s||(T=-1,u=-1)}return m[T+u*i]=c.startingPosition.id,[m,g]},d=(i,t,e,s,h,a,n)=>{let r=0;for(let o=s-h;o<=s+h;o++)for(let s=e-h;s<=e+h;s++)i[s+o*t]===n&&r++;return r>=a},l={wood:{imageX:0,imageY:11},stone:{imageX:1,imageY:11}};class m{constructor(i){t(this,"id"),t(this,"isFarmable",!1),t(this,"isPassable",!0),t(this,"isOnGrass",!1),t(this,"isOnSand",!1),t(this,"color",0),this.id=i}update(i,t,e){}getOutcome(){}}class g extends m{constructor(i){super(i),this.color=1096065}render(i,t,e,s,h,a){const n=i.getTile(e,s-1).id===this.id||i.getTile(e,s-1).id===c.tree.id||i.getTile(e,s-1).id===c.flower.id,r=i.getTile(e,s+1).id===this.id||i.getTile(e,s+1).id===c.tree.id||i.getTile(e,s+1).id===c.flower.id,o=i.getTile(e-1,s).id===this.id||i.getTile(e-1,s).id===c.tree.id||i.getTile(e-1,s).id===c.flower.id,d=i.getTile(e+1,s).id===this.id||i.getTile(e+1,s).id===c.tree.id||i.getTile(e+1,s).id===c.flower.id,l=i.getTile(e-1,s-1).id===this.id||i.getTile(e-1,s-1).id===c.tree.id||i.getTile(e-1,s-1).id===c.flower.id,m=i.getTile(e+1,s-1).id===this.id||i.getTile(e+1,s-1).id===c.tree.id||i.getTile(e+1,s-1).id===c.flower.id,g=i.getTile(e-1,s+1).id===this.id||i.getTile(e-1,s+1).id===c.tree.id||i.getTile(e-1,s+1).id===c.flower.id,T=i.getTile(e+1,s+1).id===this.id||i.getTile(e+1,s+1).id===c.tree.id||i.getTile(e+1,s+1).id===c.flower.id;n||o?n&&o&&!l?i.renderTile(t,32,32,e,s,h,a):i.renderTile(t,o?8:0,n?32:24,e,s,h,a):i.renderTile(t,0,24,e,s,h,a),n||d?n&&d&&!m?i.renderTile(t,24,32,e,s,h+8,a):i.renderTile(t,d?8:16,n?32:24,e,s,h+8,a):i.renderTile(t,16,24,e,s,h+8,a),r||o?r&&o&&!g?i.renderTile(t,32,24,e,s,h,a+8):i.renderTile(t,o?8:0,r?32:40,e,s,h,a+8):i.renderTile(t,0,40,e,s,h,a+8),r||d?r&&d&&!T?i.renderTile(t,24,24,e,s,h+8,a+8):i.renderTile(t,d?8:16,r?32:40,e,s,h+8,a+8):i.renderTile(t,16,40,e,s,h+8,a+8)}}const c={water:new class extends m{constructor(i){super(i),t(this,"position1",0),t(this,"position2",0),t(this,"position3",0),t(this,"position4",0),t(this,"shouldAnimate",!0),this.isPassable=!1,this.color=3900150}render(i,t,e,s,h,a){this.shouldAnimate&&(this.position1=Math.round(3+3*Math.random()),this.position2=Math.round(3+3*Math.random()),this.position3=Math.round(3+3*Math.random()),this.position4=Math.round(3+3*Math.random()),this.shouldAnimate=!1);const n=i.getTile(e,s-1).id===this.id,r=i.getTile(e,s+1).id===this.id,o=i.getTile(e-1,s).id===this.id,d=i.getTile(e+1,s).id===this.id,l=i.getTile(e-1,s-1).id===this.id,m=i.getTile(e+1,s-1).id===this.id;n||o?n&&o&&!l?i.renderTile(t,32,8,e,s,h,a):n&&o?i.renderTile(t,8*this.position1,16,e,s,h,a):i.renderTile(t,o?8:0,n?8:0,e,s,h,a):i.renderTile(t,0,0,e,s,h,a),n||d?n&&d&&!m?i.renderTile(t,24,8,e,s,h+8,a):n&&d?i.renderTile(t,8*this.position2,16,e,s,h+8,a):i.renderTile(t,d?8:16,n?8:0,e,s,h+8,a):i.renderTile(t,16,0,e,s,h+8,a),r||o?r&&o?i.renderTile(t,8*this.position3,16,e,s,h,a+8):i.renderTile(t,o?8:0,r?8:16,e,s,h,a+8):i.renderTile(t,0,16,e,s,h,a+8),r||d?r&&d?i.renderTile(t,8*this.position4,16,e,s,h+8,a+8):i.renderTile(t,d?8:16,r?8:16,e,s,h+8,a+8):i.renderTile(t,16,16,e,s,h+8,a+8),n&&!o&&l&&i.renderTile(t,32,0,e,s,h,a-8),n&&!d&&m&&i.renderTile(t,24,0,e,s,h+8,a-8)}update(i,t,e){i.tickCount%10==0&&(this.shouldAnimate=!0)}}(0),grass:new g(1),sand:new class extends m{constructor(i){super(i),this.color=16498468}render(i,t,e,s,h,a){i.renderTile(t,40,0,e,s,h,a),i.renderTile(t,40,0,e,s,h+8,a),i.renderTile(t,40,0,e,s,h,a+8),i.renderTile(t,40,0,e,s,h+8,a+8)}}(2),tree:new class extends m{constructor(i){super(i),this.isFarmable=!0,this.isPassable=!1,this.isOnGrass=!0,this.color=417606}render(i,t,e,s,h,a){const n=16,r=72,o=i.getTile(e,s-1).id===this.id,d=i.getTile(e-1,s).id===this.id,l=i.getTile(e+1,s).id===this.id,m=i.getTile(e,s+1).id===this.id,g=i.getTile(e-1,s-1).id===this.id,c=i.getTile(e+1,s-1).id===this.id,T=i.getTile(e-1,s+1).id===this.id,u=i.getTile(e+1,s+1).id===this.id;o&&g&&d?i.renderTile(t,32,r,e,s,h,a):i.renderTile(t,n,r,e,s,h,a),o&&c&&l?i.renderTile(t,32,80,e,s,h+8,a):i.renderTile(t,24,r,e,s,h+8,a),m&&T&&d?i.renderTile(t,32,80,e,s,h,a+8):i.renderTile(t,n,80,e,s,h,a+8),m&&u&&l?i.renderTile(t,32,r,e,s,h+8,a+8):i.renderTile(t,24,80,e,s,h+8,a+8)}getOutcome(){return{amount:3,type:"wood"}}}(3),rock:new class extends m{constructor(i){super(i),this.isFarmable=!0,this.isPassable=!1,this.color=10265519}render(i,t,e,s,h,a){const n=i.getTile(e,s-1).id===this.id,r=i.getTile(e,s+1).id===this.id,o=i.getTile(e-1,s).id===this.id,d=i.getTile(e+1,s).id===this.id,l=i.getTile(e-1,s-1).id===this.id,m=i.getTile(e+1,s-1).id===this.id,g=i.getTile(e-1,s+1).id===this.id,c=i.getTile(e+1,s+1).id===this.id;n||o?n&&o&&!l?i.renderTile(t,32,56,e,s,h,a):i.renderTile(t,o?8:0,n?56:48,e,s,h,a):i.renderTile(t,0,48,e,s,h,a),n||d?n&&d&&!m?i.renderTile(t,24,56,e,s,h+8,a):i.renderTile(t,d?8:16,n?56:48,e,s,h+8,a):i.renderTile(t,16,48,e,s,h+8,a),r||o?r&&o&&!g?i.renderTile(t,32,48,e,s,h,a+8):i.renderTile(t,o?8:0,r?56:64,e,s,h,a+8):i.renderTile(t,0,64,e,s,h,a+8),r||d?r&&d&&!c?i.renderTile(t,24,48,e,s,h+8,a+8):i.renderTile(t,d?8:16,r?56:64,e,s,h+8,a+8):i.renderTile(t,16,64,e,s,h+8,a+8)}getOutcome(){return{amount:3,type:"stone"}}}(4),flower:new class extends m{constructor(i){super(i),this.isOnGrass=!0,this.color=1096065}render(i,t,e,s,h,a){i.renderTile(t,48,0,e,s,h+4,a+4)}}(5),cactus:new class extends m{constructor(i){super(i),this.isOnSand=!0,this.color=16498468}render(i,t,e,s,h,a){i.renderTile(t,56,0,e,s,h,a),i.renderTile(t,64,0,e,s,h+8,a),i.renderTile(t,56,8,e,s,h,a+8),i.renderTile(t,64,8,e,s,h+8,a+8)}}(6),dirt:new class extends m{constructor(i){super(i),this.color=7877903}render(i,t,e,s,h,a){const n=i.getTile(e,s-1).id===this.id,r=i.getTile(e,s+1).id===this.id,o=i.getTile(e-1,s).id===this.id,d=i.getTile(e+1,s).id===this.id,l=i.getTile(e-1,s-1).id===this.id,m=i.getTile(e+1,s-1).id===this.id,g=i.getTile(e-1,s+1).id===this.id,c=i.getTile(e+1,s+1).id===this.id;n||o?n&&o&&!l?i.renderTile(t,72,32,e,s,h,a):i.renderTile(t,o?48:40,n?32:24,e,s,h,a):i.renderTile(t,40,24,e,s,h,a),n||d?n&&d&&!m?i.renderTile(t,64,32,e,s,h+8,a):i.renderTile(t,d?48:56,n?32:24,e,s,h+8,a):i.renderTile(t,56,24,e,s,h+8,a),r||o?r&&o&&!g?i.renderTile(t,72,24,e,s,h,a+8):i.renderTile(t,o?48:40,r?32:40,e,s,h,a+8):i.renderTile(t,40,40,e,s,h,a+8),r||d?r&&d&&!c?i.renderTile(t,64,24,e,s,h+8,a+8):i.renderTile(t,d?48:56,r?32:40,e,s,h+8,a+8):i.renderTile(t,56,40,e,s,h+8,a+8)}}(7),startingPosition:new g(999)},T=Object.entries(c).map((([i,t])=>t));var u,f;(f=u||(u={}))[f.OWNED=1]="OWNED",f[f.VISIBLE=6]="VISIBLE";class w{constructor(i,e,s){t(this,"map2d"),t(this,"imageData"),t(this,"minimapCanvas",document.createElement("canvas")),t(this,"width"),t(this,"height"),this.map2d=i,this.width=e,this.height=s,this.imageData=i.createImageData(e,s),this.minimapCanvas.width=this.imageData.width,this.minimapCanvas.height=this.imageData.height}getRGB(i){return[i>>16&255,i>>8&255,255&i]}render(i,t,e,s){const h=Math.floor(this.map2d.canvas.width/s)-i.width/(e+s+10)-8,a=Math.round(i.width/(e+s+10));for(let n=0;n<this.height;n++)for(let i=0;i<this.width;i++){const e=i+n*this.width,s=t.getTile(i,n),[h,a,r]=this.getRGB(s.color);t.getTileState(i,n,u.OWNED)?(this.imageData.data[4*e]=255,this.imageData.data[4*e+1]=0,this.imageData.data[4*e+2]=0,this.imageData.data[4*e+3]=255):t.getTileState(i,n,u.VISIBLE)>=1?(this.imageData.data[4*e]=h,this.imageData.data[4*e+1]=a,this.imageData.data[4*e+2]=r,this.imageData.data[4*e+3]=255):(this.imageData.data[4*e]=0,this.imageData.data[4*e+1]=0,this.imageData.data[4*e+2]=0,this.imageData.data[4*e+3]=255)}this.minimapCanvas.getContext("2d").putImageData(this.imageData,0,0),this.map2d.drawImage(this.minimapCanvas,h,8,a,a),this.map2d.strokeStyle="rgba(255, 255, 255, 0.35)",this.map2d.strokeRect(h,8,a,a)}}let p=!1,x=!1;window.onload=()=>{p=!0,L()};let y=!1,M=!1,v=0,S=0,A=0,D=0,I=0,b=0;let k=3;let E=0;const X=(i=>{const t=new Image;return E++,t.onload=()=>{E--,0===E&&L()},t.src=i,t})(e),P=document.querySelector("#map"),z=P.getContext("2d"),O=new class{constructor(){t(this,"scrollX",0),t(this,"scrollY",0),t(this,"scrollSpeed",3),t(this,"keys",[]),window.onkeydown=i=>{this.keys[i.keyCode]=!0},window.onkeyup=i=>{this.keys[i.keyCode]=!1}}update(i,t,e,s){return this.scrollX=i,this.scrollY=t,this.keys[87]&&(this.scrollY+=this.scrollSpeed),this.keys[65]&&(this.scrollX+=this.scrollSpeed),this.keys[83]&&(this.scrollY-=this.scrollSpeed),this.keys[68]&&(this.scrollX-=this.scrollSpeed),this.keys[27]&&e&&e(),this.keys[49]&&s&&s(),[this.scrollX,this.scrollY]}};let Y;const C=new Array(1);for(let ii=0;ii<C.length;ii++)C[ii]={name:"Base",imageX:0,imageY:9};const N=new class{constructor(i,s,h){t(this,"tiles"),t(this,"data"),t(this,"tilesState"),t(this,"tileSize",16),t(this,"tickCount",0),t(this,"tileImage"),t(this,"imagesToLoad",0),t(this,"width"),t(this,"height"),t(this,"seed"),t(this,"entities",[]),t(this,"onTopTiles",[]),this.width=i,this.height=s,this.seed=h,this.tiles=new Array(i*s),this.data=new Array(i*s),this.tilesState=new Array(i*s),this.tileImage=this.loadImage(e)}loadImage(i){var t=new Image;return this.imagesToLoad++,t.onload=()=>{this.imagesToLoad--,0===this.imagesToLoad&&this.init()},t.src=i,t}init(){const i=((i,t,e=Math.random()*Number.MAX_SAFE_INTEGER)=>{for(;;){const s=o(i,t,e),h=new Array(256);for(let e=0;e<i*t;e++)h[255&s[0][e]]++;if(!(h[255&c.rock.id]<100||h[255&c.sand.id]<100||h[255&c.grass.id]<100||h[255&c.tree.id]<100))return s}})(this.width,this.height,this.seed);this.tiles=i[0],this.tilesState=[...i[1]],this.data=[...i[1]],this.tilesState.fill(0);for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++){if(this.tiles[i+t*this.width]===c.startingPosition.id)for(let e=0;e<5;e++)this.entities.push(0===Math.round(1*Math.random())?new h(i,t):new a(i,t))}}update(){this.tickCount++,this.tickCount>=Number.MAX_VALUE&&(this.tickCount=0);for(let i=0;i<this.width*this.height/50;i++){const i=Math.round(Math.random()*this.width),t=Math.round(Math.random()*this.height);this.getTile(i,t).update(this,i,t)}this.entities.filter((i=>!i.isDead)).forEach((i=>i.update(this)))}render(i,t,e,s,h){const a=Math.floor(-e/this.tileSize),n=Math.floor(-s/this.tileSize),r=Math.ceil((-e+i.width/h)/this.tileSize),o=Math.ceil((-s+i.height/h)/this.tileSize);for(let d=n;d<o;d++)for(let i=a;i<r;i++){const h=this.getTile(i,d),a=this.getTileState(i,d,1);if(h.isOnGrass){T.find((i=>i.id===c.grass.id)).render(this,t,i,d,e,s)}else if(h.isOnSand){T.find((i=>i.id===c.sand.id)).render(this,t,i,d,e,s)}h.render(this,t,i,d,e,s),1===a&&t.drawImage(this.tileImage,0,72,16,16,i*this.tileSize+e,d*this.tileSize+s,16,16)}this.entities.forEach((i=>i.render(this,t,e,s))),this.onTopTiles.forEach((i=>{this.renderTile(t,i.sx,i.sy,i.x,i.y,i.xExtraOffset+e,i.yExtraOffset+s)}));for(let d=n;d<o;d++)for(let i=a;i<r;i++){const h=this.getTileState(i,d,6);if(1===h)t.drawImage(this.tileImage,240,16,8,8,i*this.tileSize+e+0,d*this.tileSize+s+0,8,8),t.drawImage(this.tileImage,240,16,8,8,i*this.tileSize+e+8,d*this.tileSize+s+0,8,8),t.drawImage(this.tileImage,240,16,8,8,i*this.tileSize+e+0,d*this.tileSize+s+8,8,8),t.drawImage(this.tileImage,240,16,8,8,i*this.tileSize+e+8,d*this.tileSize+s+8,8,8);else for(let a=0;a<4;a++){const n=a%2*2-1,r=2*(a>>1)-1,o=this.getTileState(i,d+r,6)!==h,l=this.getTileState(i+n,d,6)!==h;let m=25,g=1;3===h&&(g+=3),o&&(g+=r),l&&(m+=n),t.drawImage(this.tileImage,8*m,8*g,8,8,i*this.tileSize+e+a%2*8,d*this.tileSize+s+8*(a>>1),8,8)}}}renderEntity(i,t,e,s,h,a,n){i.drawImage(this.tileImage,t,e,this.tileSize,this.tileSize,s*this.tileSize+a,h*this.tileSize+n,this.tileSize,this.tileSize)}renderTile(i,t,e,s,h,a,n){i.drawImage(this.tileImage,t,e,8,8,s*this.tileSize+a,h*this.tileSize+n,8,8)}getTile(i,t){if(i<0||t<0||i>=this.width||t>=this.height)return c.water;const e=T.find((e=>this.tiles[i+t*this.width]===e.id));return null!=e?e:c.water}getTileState(i,t,e){return i<0||t<0||i>=this.width||t>=this.height?0:6===e?(this.tilesState[i+t*this.width]&e)>>1:this.tilesState[i+t*this.width]&e}setTileState(i,t,e,s){if(!(i<0||t<0||i>=this.width||t>=this.height))if(6===s){const s=this.tilesState[i+t*this.width];this.tilesState[i+t*this.width]=e<<1|1&s}else this.tilesState[i+t*this.width]^=e,this.tiles[i+t*this.width]=c.dirt.id}setTile(i,t,e){i<0||t<0||i>=this.width||t>=this.height||(this.tiles[i+t*this.width]=e.id)}setData(i,t,e){i<0||t<0||i>=this.width||t>=this.height||(this.data[i+t*this.width]=e)}getData(i,t){return i<0||t<0||i>=this.width||t>=this.height?0:255&this.data[i+t*this.width]}recalcVisibility(){for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++){let e=this.getTileState(t,i,6);3===e&&(e>>=1),this.setTileState(t,i,e,6)}for(let i=0;i<this.height;i++)for(let t=0;t<this.width;t++){this.getTileState(t,i,1)&&this.revealTile(t,i,4)}}revealTile(i,t,e){for(let s=t-e;s<=t+e;s++)if(!(s<0||s>=this.height))for(let h=i-e;h<=i+e;h++){if(h<0||h>=this.width)continue;const a=h-i,n=s-t;if(a*a+n*n<=e*e+2){if(0===s||0===h||h===this.width-1||s===this.height-1)continue;this.setTileState(h,s,3,6)}}}}(128,128),L=()=>{if(p&&!(E>0)){if(P.width=window.innerWidth,P.height=window.innerHeight,Y=new w(z,128,128),P.onmousedown=i=>{i.preventDefault(),y=!0,M=!1,v=i.clientX,S=i.clientY},P.onclick=i=>{if(y=!1,!M){const t=Math.floor(A+16*-I+window.innerWidth/k/2),e=Math.floor(D+16*-b+window.innerHeight/k/2),s=Math.floor((i.clientX/k-t)/16),h=Math.floor((i.clientY/k-e)/16);R(s,h,i.clientX/k,i.clientY/k)}},window.onmousemove=i=>{if(!y)return;i.preventDefault();const t=i.clientX-v,e=i.clientY-S;(M||t*t+e*e>64)&&(M=!0,A+=t/k,D+=e/k,v=i.clientX,S=i.clientY)},!x){for(let i=0;i<128;i++)for(let t=0;t<128;t++){const e=t+128*i;N.tiles[e]===c.startingPosition.id&&(I=t,b=i,N.setTileState(I,b,1,u.OWNED),N.recalcVisibility())}_(),x=!0}U()}};window.onresize=L;let V=null,W=null,G=!1;const R=(i,t,e=800,s=600)=>{const h=Math.floor(z.canvas.width/k),a=Math.floor(z.canvas.height/k);if(e>=0&&e<=h&&s>=a-35&&s<=a&&V&&W){return void(N.getTile(V,W).isPassable&&Z(e,s))}if(i<0||t<0||i>128||t>128)return V=null,void(W=null);const n=N.getTileState(i,t,u.VISIBLE);if(0===n)return V=null,void(W=null);V===i&&W===t||(V=i,W=t,G=3===n)};let B=Date.now(),F=Date.now(),q=0;const _=()=>{requestAnimationFrame(_),B=F,F=Date.now(),q+=F-B,q>=60&&(q=0,H());const i=O.update(A,D,(()=>{}),(()=>{if(V&&W){for(let i=0;i<5;i++)N.entities.push(0===Math.round(1*Math.random())?new h(V,W):new a(V,W));N.setTileState(V,W,1,u.OWNED),N.recalcVisibility(),V=null,W=null}}));A===i[0]&&D===i[1]||(A=i[0],D=i[1]),U()},H=()=>{N.update()},U=()=>{k=Math.max(Math.floor(P.height/300+1),Math.floor(P.width/(16/9*300)+1)),A>16*I&&(A=16*I),D>16*b&&(D=16*b),A<16*I-2016&&(A=16*I-2016),D<16*b-2016&&(D=16*b-2016),z.imageSmoothingEnabled=!1,z.setTransform(k,0,0,k,0,0);const i=Math.floor(A+16*-I+window.innerWidth/k/2),t=Math.floor(D+16*-b+window.innerHeight/k/2);N.render(P,z,i,t,k);for(var e=0;e<C.length;e++){const i=Math.floor(z.canvas.width/k),t=Math.floor(z.canvas.height/k);z.fillStyle="rgba(255, 255, 255, 0.3)",z.fillRect(0,t-35,i,t),Q(C[e].name,i/2+2,t-25-5,3),$(C[e].imageX,C[e].imageY,i/2,t-25)}if(V&&W&&(z.strokeStyle="white",z.strokeRect(16*V+i,16*W+t,16,16),G)){const e=N.getTile(V,W).getOutcome();e&&(z.fillStyle="rgba(0, 0, 0, 0.3)",z.fillRect(16*V+i+16,16*W+t,18,16),z.drawImage(X,8*l[e.type].imageX,8*l[e.type].imageY,8,8,16*V+i+18,16*W+t+4,8,8),Q(`${e.amount}`,16*V+i+27,16*W+t+5,5))}K(),Y.render(P,N,16,k)},j=[{imageX:0,imageY:11},{imageX:1,imageY:11}],K=()=>{for(let i=0;i<j.length;i++)z.drawImage(X,8*j[i].imageX,8*j[i].imageY,8,8,4,4+14*i,8,8),Q("0",14,5+14*i,6)},J="ABCDEFGHIJKLMNOPQRSTUVWXYZ      0123456789.,!?'\":;()+-=*/\\%     ",Q=(i,t,e,s=8)=>{i=i.toUpperCase();for(var h=0;h<i.length;h++){var a=J.indexOf(i.charAt(h)),n=0+a%32,r=29+(a>>5);z.drawImage(X,8*n,8*r,8,8,t+h*s,e,s,s)}},Z=(i,t)=>{const e=Math.floor(z.canvas.width/k)/2,s=Math.floor(z.canvas.height/k)-25;i>=e&&i<=e+16&&t>=s&&t<=s+16&&V&&W&&(N.setTileState(V,W,1,u.OWNED),N.recalcVisibility(),V=null,W=null)},$=(i,t,e,s)=>{z.beginPath(),z.strokeStyle="yellow",z.rect(e,s,16,16),z.stroke(),z.drawImage(X,8*i,8*t,16,16,e,s,16,16)};
